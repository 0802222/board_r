name: Deploy to Production (Blue-Green)

on:
  push:
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/board-production

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=,format=short
            type=raw,value=latest

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Blue-Green Deployment
        uses: appleboy/ssh-action@v1.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
          REGISTRY: ${{ env.REGISTRY }}
          IMAGE_NAME: ${{ env.IMAGE_NAME }}
          DB_URL: ${{ secrets.PROD_DB_URL }}
          DB_USER: ${{ secrets.PROD_DB_USERNAME }}
          DB_PASS: ${{ secrets.PROD_DB_PASSWORD }}
          JWT_SEC: ${{ secrets.JWT_SECRET }}
          JWT_ACCESS: ${{ secrets.JWT_ACCESS_EXPIRATION }}
          JWT_REFRESH: ${{ secrets.JWT_REFRESH_EXPIRATION }}
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: 22
          envs: GITHUB_TOKEN,GITHUB_ACTOR,REGISTRY,IMAGE_NAME,DB_URL,DB_USER,DB_PASS,JWT_SEC,JWT_ACCESS,JWT_REFRESH
          script: |
            set -e

            echo $GITHUB_TOKEN | docker login ghcr.io -u $GITHUB_ACTOR --password-stdin

            # .env íŒŒì¼ ìƒì„± (í™˜ê²½ë³€ìˆ˜ì—ì„œ ì£¼ìž…)
            cat > .env << EOF
            JDBC_DATABASE_URL=$DB_URL
            JDBC_DATABASE_USERNAME=$DB_USER
            JDBC_DATABASE_PASSWORD=$DB_PASS
            JWT_SECRET=$JWT_SEC
            JWT_ACCESS_EXPIRATION=$JWT_ACCESS
            JWT_REFRESH_EXPIRATION=$JWT_REFRESH
            EOF

            docker pull $REGISTRY/$IMAGE_NAME:latest
            
            if docker ps --format '{{.Names}}' | grep -q "^board-blue$"; then
              CURRENT="blue"
              CURRENT_PORT=8080
              NEW="green"
              NEW_PORT=8081
            elif docker ps --format '{{.Names}}' | grep -q "^board-green$"; then
              CURRENT="green"
              CURRENT_PORT=8081
              NEW="blue"
              NEW_PORT=8080
            else
              CURRENT=""
              CURRENT_PORT=""
              NEW="blue"
              NEW_PORT=8080
              echo "Initial deployment - starting with Blue"
            fi
            
            echo "Current: ${CURRENT:-none} (port ${CURRENT_PORT:-none})"
            echo "Deploying to: $NEW (port $NEW_PORT)"
            
            docker stop board-$NEW 2>/dev/null || true
            docker rm -f board-$NEW 2>/dev/null || true
            
            docker run -d \
              --name board-$NEW \
              --restart unless-stopped \
              --network bridge \
              -p $NEW_PORT:8080 \
              -e SPRING_PROFILES_ACTIVE=prod \
              -e JDBC_DATABASE_URL="$DB_URL" \
              -e JDBC_DATABASE_USERNAME="$DB_USER" \
              -e JDBC_DATABASE_PASSWORD="$DB_PASS" \
              -e JWT_SECRET="$JWT_SEC" \
              -e JWT_ACCESS_EXPIRATION="$JWT_ACCESS" \
              -e JWT_REFRESH_EXPIRATION="$JWT_REFRESH" \
              -v /home/ubuntu/board-uploads:/app/uploads \
              --health-cmd="curl -f http://localhost:8080/actuator/health || exit 1" \
              --health-interval=10s \
              --health-timeout=5s \
              --health-retries=3 \
              $REGISTRY/$IMAGE_NAME:latest
            
            echo "Waiting for new container to be healthy..."
            TIMEOUT=120
            ELAPSED=0
            
            while [ $ELAPSED -lt $TIMEOUT ]; do
              if docker inspect --format='{{.State.Health.Status}}' board-$NEW 2>/dev/null | grep -q "healthy"; then
                echo "âœ… New container is healthy!"
                break;
              fi
              
              echo "Waiting... $((ELAPSED/5))/24 attempts"
              sleep 5
              ELAPSED=$((ELAPSED + 5))
            done
            
            if [ $ELAPSED -ge $TIMEOUT ]; then
                echo "âŒ Health check timeout after ${TIMEOUT}s"
                docker logs --tail 50 board-$NEW
                docker stop board-$NEW
                docker rm board-$NEW
                exit 1
              fi
            
            if ! sudo bash /home/ubuntu/scripts/switch-nginx.sh $NEW_PORT; then
              echo  "âŒ Nginx switch failed"
              docker stop board-$NEW
              docker rm board-$NEW
              exit 1
            fi
            
            if ! sudo nginx -t; then
              echo "âŒ Nginx config test failed - Rolling back"
              sudo cp /etc/nginx/sites-available/default.backup \
                      /etc/nginx/sites-available/default
              docker stop board-$NEW
              docker rm board-$NEW
              exit 1
            fi
            
            sudo systemctl reload nginx
            echo "âœ… Traffic switched to $NEW (port $NEW_PORT)"
            
            echo "Verifying post-deployment health..."
            for i in {1..5}; do
              if ! curl -f http://localhost:$NEW_PORT/actuator/health >/dev/null 2>&1; then
                echo "âŒ Post-deployment check failed (attempt $i/5)"
                
                if [ -n "$CURRENT" ]; then
                sudo bash /home/ubuntu/scripts/switch-nginx.sh $CURRENT_PORT
                sudo systemctl reload nginx
                fi
                
                docker stop board-$NEW
                docker rm board-$NEW
                
                if [ -n "$CURRENT" ]; then
                  echo "âœ… Rolled back to $CURRENT (port $CURRENT_PORT)"
                  else
                  echo "âœ… Deployment cancelled (no rollback target)"
                fi
                exit 1
              fi
              echo "âœ“ Health check $i/5 passed"
              sleep 6
            done
              
            echo "âœ… Post-deployment verification completed"
            
            sleep 30
            
            if [ -n "$CURRENT" ]; then
              echo "Stopping old container: $CURRENT"
              docker stop board-$CURRENT 2>/dev/null || true
              docker rm board-$CURRENT 2>/dev/null || true
            fi
            
            docker image prune -af
            
            echo "ðŸŽ‰ Blue-Green deployment completed successfully!"
            echo "Active: $NEW (port $NEW_PORT)"